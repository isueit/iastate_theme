{#
/**
 * @file
 * Default theme implementation to display a menu.
 *
 * Available variables:
 * - menu_name: The machine name of the menu.
 * - items: A nested list of menu items. Each menu item contains:
 *   - attributes: HTML attributes for the menu item.
 *   - below: The menu item child items.
 *   - title: The menu link title.
 *   - url: The menu link url, instance of \Drupal\Core\Url
 *   - localized_options: Menu link localized options.
 *   - is_expanded: TRUE if the link has visible children within the current
 *     menu tree.
 *   - is_collapsed: TRUE if the link has children within the current menu tree
 *     that are not currently visible.
 *   - in_active_trail: TRUE if the link is in the active trail.
 *
 * @ingroup themeable
 */
#}
{% import _self as menus %}

{{ menus.menu_links(items, attributes, 0) }}

{% macro menu_links(items, attributes, menu_level) %}
  {% import _self as menus %}
  {% if items %}
    <ul role="{{ menu_level == 0 ? 'menubar' : 'menu' }}"
        {{ attributes.addClass(menu_level == 0 ? 'nav navbar-nav menubar' : 'isu-dropdown-menu')
          .setAttribute('aria-hidden', menu_level > 0 ? 'true' : null) }}>

      {% for item in items %}
        {% set li_classes = [
          menu_level == 0 ? 'nav-item' : 'dropdown-item isu-dropdown-item',
          item.below ? 'isu-dropdown' : ''
        ] %}

        <li class="{{ li_classes|join(' ') }}" role="menuitem"
            {{ item.attributes.setAttribute('aria-expanded', item.below ? 'false' : null)
                .setAttribute('aria-haspopup', item.below ? 'true' : 'false') }}>

          {# Main navigation link; prevent navigation if it's a dropdown #}
          <a href="{{ item.below ? '#' : item.url }}"
             class="nav-link isu-nav-link {{ item.below ? 'isu-dropdown-toggle' : '' }}"
             {% if item.below %} data-url="{{ item.url }}" {% endif %}
             aria-expanded="false">
            {{ item.title }}
          </a>

          {% if item.below %}
            {# Submenu structure: Includes Back button, Parent link, and submenu items #}
            <ul role="menu" class="isu-dropdown-menu" aria-hidden="true">

                <li class="isu-dropdown-back-wrap">
                  <button class="isu-dropdown-back" tabindex="-1">
                    <span class="isu-dropdown-back-icon" aria-hidden="true">&lt;</span>
                    <span class="isu-dropdown-back-label">Back</span>
                    <span class="sr-only"> to top level of menu</span>
                  </button>
                </li>


              {# ðŸ“Œ Parent Link: Clickable version of the parent menu item inside submenu #}
              <li class="isu-dropdown-parent-wrap">
                <a class="nav-link isu-nav-link" href="{{ item.url }}" tabindex="-1">
                  {{ item.title }} <span class="arrow"></span>
                </a>
              </li>

              {# ðŸ”½ Submenu Items: Render submenu items inside the same <ul> #}
              {% for child in item.below %}
                {% set child_classes = [
                  'dropdown-item isu-dropdown-item',
                  child.below ? 'isu-dropdown' : ''
                ] %}
                <li class="{{ child_classes|join(' ') }}" role="menuitem"
                    {{ child.attributes.setAttribute('aria-expanded', child.below ? 'false' : null)
                        .setAttribute('aria-haspopup', child.below ? 'true' : 'false') }}>
                  <a href="{{ child.url }}"
                     class="nav-link isu-nav-link {{ child.below ? 'isu-dropdown-toggle' : '' }}"
                     {% if child.below %} data-url="{{ child.url }}" {% endif %}
                     aria-expanded="false">
                    {{ child.title }}
                  </a>

                  {# Recursively render deeper submenus (nested structure) #}
                  {% if child.below %}
                    {{ menus.menu_links(child.below, attributes, menu_level + 1) }}
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}
{% endmacro %}
